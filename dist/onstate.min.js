/* onstate 0.5.0 - https://github.com/passpill-io/onState */
!function(t,e){"function"==typeof define&&define.amd?define(["exports","onState"],e):"object"==typeof exports?module.exports=e():t.onState=e()}(this,function(){"use strict";const t=new Set(["_mark","state"]);function e(t){console.warn("onState WARNING: "+t)}function n(t){if(t.slice)return t.slice();var e={};for(var n in t)e[n]=t[n];return e}var r,i=[];function o(){for(var t;t=i.shift();)t()}if("undefined"!=typeof window){let t=window.origin;t&&"null"!==t||(t="*"),window.addEventListener("message",function(t){"now"===t.data&&o()}),r=window.postMessage.bind(window,"now",t)}else r=function(){process.nextTick(o)};var a=function(t){return i.push(t),r(),1},s={on:function(t,n){return t?"function"!=typeof n?e("No listener provided for the event '"+t+"'."):void(this.__.clbks[t]?this.__.clbks[t].push(n):this.__.clbks[t]=[n]):e("Can't add listener for a falsy event.")},off:function(t,n){var r=this.__.clbks[t],i="Couldn't find the listener to remove from the event '"+t+"'.";if(!r)return e(i);var o=r.indexOf(n);-1!==o?r.splice(o,1):e(i)},emit:function(e){var n=Array.from(arguments),r=_.apply(null,[this.__].concat(n));if(t.has(e))return r;for(var i=this.__.parent;i;)_.apply(null,[i].concat(n)),i=i.parent;return r}};function _(t,n){if(t.clbks[n]){var r,i,o=Array.from(arguments).slice(2);return t.clbks[n].forEach(t=>{void 0!==(i=t.apply(null,o))&&(r=i)}),r}"_mark"===n&&e("Changing a detached node. It won't emit `state` events.")}function c(t){var e=f(t);return delete t.__.splicing,delete t.__.clbks._mark,t.emit("state",e),e}var u={set:function(t,r,i){!this.__.init&&i&&i.__&&i.__.parent&&!this.__.splicing&&function(t){throw new Error(t)}("Can't add an oS node to another oS object."),i&&!i.__&&(i.on||i.emit)&&e("Adding an object with `on` or `emit` attributes. They will be overriden.");var o=i instanceof Object,a=o?d(i):i;if(o&&(a.__.parent=this.__),this.__.init)t[r]=a;else{var s=this.__.update;s||(s=this.__.update=n(t)),s[r]=a,_(this.__,"_mark")}return!0},deleteProperty:function(t,e){var r=this.__.update;return r||(r=this.__.update=n(t)),delete r[e],_(this.__,"_mark"),!0},get:function(t,e){var n=this.__.update||t;return n.splice&&"splice"===e&&(this.__.splicing=!0),"__"===e?this.__:s[e]?s[e]:n[e]||n.hasOwnProperty(e)?n[e]:Reflect.get(n,e)}};function f(t,e){var n,r,i=t.splice?[]:{},o={parent:!1,clbks:{},timer:!1,init:!0},s=Object.assign({__:o},u),f=t;if(t&&(r=t.__)&&r.clbks)for(l in n=r.marked,f=r.update||t,r.parent&&delete r.update,r.clbks)"_mark"!==l&&(o.clbks[l]=r.clbks[l]);var d,l,p=new Proxy(i,s);for(l in d=n?function(t){return n.has(t)?c(t):t}:function(t){return t},f)p[l]=d(f[l]);return delete o.init,p.on("_mark",function(){!function(t){var e=t.__.parent;if(e){var n=e.marked||new Set;n.add(t),e.marked=n,_(e,"_mark")}else t.__.timer||(t.__.timer=a(()=>{t.__.update=c(t)}))}(p)}),p}function d(t){return function(t){return t&&t.__}(t)?t:f(t)}return d});