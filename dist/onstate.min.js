/* onstate 1.0.0 - https://github.com/passpill-io/onState */
!function(e,t){"function"==typeof define&&define.amd?define(["exports","onState"],t):"object"==typeof exports?module.exports=t():e.onState=t()}(this,function(){"use strict";var e,t=[];function n(){let e;for(;e=t.shift();)e()}if("undefined"!=typeof window&&window.setImmediate){let t=!1;e=function(){t||(t=window.setImmediate(function(){t=!1,n()}))}}else if("undefined"!=typeof window&&window.addEventListener){let t=window.origin;t&&"null"!==t||(t="*"),window.addEventListener("message",function(e){"now"===e.data&&n()}),e=window.postMessage.bind(window,"now",t)}else e=function(){process.nextTick(n)};var i=function(n){return t.push(n),e(),1};function r(e){var t=e.__.parent;if(t){var n=t.dirtyNodes||new Set;n.add(e),t.dirtyNodes=n,t.setDirty()}else e.__.timer||(e.__.timer=i(()=>{delete e.__.timer,function(e){if(e.__.rebuild=1,e.__.nextState){let t=e.__.nextState;for(key in delete e.__.nextState,e)delete e[key];for(key in t)e[key]=_(e.__,t[key])}else for(key in e)e[key]=_(e.__,e[key]);delete e.__.rebuild}(e),e.emitChange(e)}))}var o={set:function(e,t,n){if(this.__.rebuild)return e[t]=n,!0;!this.__.init&&n&&n.__&&n.__.parent&&!this.__.splicing&&function(e){throw new Error(e)}("Can't add an oS node to another oS object."),n&&!n.__&&(n.on||n.emit)&&c("Adding an object with `on` or `emit` attributes. They will be overriden.");var i=n instanceof Object,r=i?a(n):n;if(i&&(r.__.parent=this.__),this.__.init)e[t]=r;else{var o=this.__.nextState;o||(o=this.__.nextState=f(e)),o[t]=r,this.__.setDirty()}return!0},deleteProperty:function(e,t){if(this.__.rebuild)return delete e[t],!0;var n=this.__.nextState;return n||(n=this.__.nextState=f(e)),delete n[t],this.__.setDirty(),!0},get:function(e,t){if("__"===t)return this.__;let n=this.__.nextState||e;return n.splice&&Array.prototype[t]&&("splice"===t&&(this.__.splicing=!0),this.__.nextState)?Array.prototype[t].bind(n):d[t]?d[t]:n[t]||n.hasOwnProperty(t)?n[t]:Reflect.get(n,t)},ownKeys:function(e){return Reflect.ownKeys(this.__.nextState||e)},getOwnPropertyDescriptor:function(e,t){return Object.getOwnPropertyDescriptor(this.__.nextState||e,t)}};function _(e,t){let n=function(e,t){if(!e||!e.dirtyNodes||!e.dirtyNodes.has(t))return t;let n=s(t);return delete t.__.splicing,t.__.detached=!0,n.__.parent=e,n}(e,t);return t!==n&&n&&n.emitChange&&n.emitChange(n),n}function s(e){let t=e&&e.__,n={parent:!1,clbks:t?e.__.clbks.slice():[],timer:!1,init:!0},i=Object.assign({__:n},o),s=new Proxy(e.splice?[]:{},i),a=t&&e.__.nextState?e.__.nextState:e;for(let t in a)s[t]=_(e.__,a[t]);return delete n.init,n.setDirty=function(){n.detached?c("Changing a detached node. It won't emit `state` events."):r(s)},s}function a(e){return function(e){return e&&e.__}(e)?e:s(e)}const d={addChangeListener:function(e){if("function"!=typeof e)return c("The listener is not a function.");this.__.clbks.push(e)},removeChangeListener:function(e){let t=this.__.clbks,n=t.length,i=!1;for(;n-- >0;)e===t[n]&&(t.splice(n,1),i=!0);i||c("Couldn't find the listener to remove.")},emitChange:function(e){this.__.clbks.forEach(t=>{t(e)})}};function c(e){console.warn("onState WARNING: "+e)}function f(e){if(e.slice)return e.slice();let t={};for(let n in e)t[n]=e[n];return t}return a});