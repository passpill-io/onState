/* onstate 0.6.0 - https://github.com/passpill-io/onState */
!function(e,t){"function"==typeof define&&define.amd?define(["exports","onState"],t):"object"==typeof exports?module.exports=t():e.onState=t()}(this,function(){"use strict";const e=new Set(["_mark","state"]);var t,n=[];function r(){for(var e;e=n.shift();)e()}if("undefined"!=typeof window){let e=window.origin;e&&"null"!==e||(e="*"),window.addEventListener("message",function(e){"now"===e.data&&r()}),t=window.postMessage.bind(window,"now",e)}else t=function(){process.nextTick(r)};var i=function(e){return n.push(e),t(),1};function o(e){var t=e.__.parent;if(t){var n=t.marked||new Set;n.add(e),t.marked=n,c(t,"_mark")}else e.__.timer||(e.__.timer=i(()=>{delete e.__.timer,function(e){var t,n,r=e.__,i=r.update||e,o=s(r);if(r.rebuild=1,r.update){for(t in e)delete e[t];for(t in i)e[t]=o(i[t]);delete r.update}else for(t in i)e[t]!==(n=o(e[t]))&&(e[t]=n);delete r.rebuild}(e),e.emit("state",e)}))}var a={set:function(e,t,n){if(this.__.rebuild)return e[t]=n,!0;!this.__.init&&n&&n.__&&n.__.parent&&!this.__.splicing&&function(e){throw new Error(e)}("Can't add an oS node to another oS object."),n&&!n.__&&(n.on||n.emit)&&d("Adding an object with `on` or `emit` attributes. They will be overriden.");var r=n instanceof Object,i=r?u(n):n;if(r&&(i.__.parent=this.__),this.__.init)e[t]=i;else{var o=this.__.update;o||(o=this.__.update=l(e)),o[t]=i,c(this.__,"_mark")}return!0},deleteProperty:function(e,t){if(this.__.rebuild)return delete e[t],!0;var n=this.__.update;return n||(n=this.__.update=l(e)),delete n[t],c(this.__,"_mark"),!0},get:function(e,t){var n=this.__.update||e;return n.splice&&"splice"===t&&(this.__.splicing=!0),"__"===t?this.__:f[t]?f[t]:n[t]||n.hasOwnProperty(t)?n[t]:Reflect.get(n,t)}};function s(e){return e&&e.marked?function(t){if(e.marked.has(t)){var n=function(e){var t=_(e);return delete e.__.splicing,delete e.__.clbks._mark,e.emit("state",t),t}(t);return n.__.parent=e,n}return t}:function(e){return e}}function _(e,t){var n,r,i=e.splice?[]:{},_={parent:!1,clbks:{},timer:!1,init:!0},u=Object.assign({__:_},a),f=e;if(e&&(n=e.__)&&n.clbks)for(r in f=n.update||e,delete n.update,n.clbks)"_mark"!==r&&(_.clbks[r]=n.clbks[r]);var c=new Proxy(i,u),d=s(n);for(r in f)c[r]=d(f[r]);return delete _.init,c.on("_mark",function(){o(c)}),c}function u(e){return function(e){return e&&e.__}(e)?e:_(e)}var f={on:function(e,t){return e?"function"!=typeof t?d("No listener provided for the event '"+e+"'."):void(this.__.clbks[e]?this.__.clbks[e].push(t):this.__.clbks[e]=[t]):d("Can't add listener for a falsy event.")},off:function(e,t){var n=this.__.clbks[e],r="Couldn't find the listener to remove from the event '"+e+"'.";if(!n)return d(r);var i=n.indexOf(t);-1!==i?n.splice(i,1):d(r)},emit:function(t){var n=Array.from(arguments),r=c.apply(null,[this.__].concat(n));if(e.has(t))return r;for(var i=this.__.parent;i;)c.apply(null,[i].concat(n)),i=i.parent;return r}};function c(e,t){if(e.clbks[t]){var n,r,i=Array.from(arguments).slice(2);return e.clbks[t].forEach(e=>{void 0!==(r=e.apply(null,i))&&(n=r)}),n}"_mark"===t&&d("Changing a detached node. It won't emit `state` events.")}function d(e){console.warn("onState WARNING: "+e)}function l(e){if(e.slice)return e.slice();var t={};for(var n in e)t[n]=e[n];return t}return u});